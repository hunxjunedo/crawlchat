name: CrawlChat Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  discussion:
    types: [created]
  discussion_comment:
    types: [created]

jobs:
  answer:
    if: >
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'discussion' && github.event.action == 'created') ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@crawlchat') &&
       github.event.comment.user.login != 'github-actions[bot]') ||
      (github.event_name == 'discussion_comment' &&
       contains(github.event.comment.body, '@crawlchat') &&
       github.event.comment.user.login != 'github-actions[bot]')
    runs-on: ubuntu-latest

    steps:
      - name: Check if bot already responded
        id: check_response
        run: |
          if [ "${{ github.event_name }}" == "issues" ] || [ "${{ github.event_name }}" == "issue_comment" ]; then
            # Get all comments on the issue
            COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "${{ github.event.issue.comments_url }}")
          else
            # Get all comments on the discussion
            COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/discussions/${{ github.event.discussion.number }}/comments")
          fi

          # Check if any comment contains our bot marker
          if echo "$COMMENTS" | jq -e '.[] | select(.body | contains("ðŸ¤– CrawlChat Answer"))' > /dev/null; then
            echo "Bot already responded"
            echo "already_responded=true" >> $GITHUB_OUTPUT
          else
            echo "Bot has not responded yet"
            echo "already_responded=false" >> $GITHUB_OUTPUT
          fi

      - name: Call CrawlChat Answer API
        if: steps.check_response.outputs.already_responded == 'false'
        id: api_call
        run: |
          # Extract the question from the issue/discussion body or comment
          if [ "${{ github.event_name }}" == "issues" ]; then
            QUESTION="${{ github.event.issue.title }} ${{ github.event.issue.body }}"
          elif [ "${{ github.event_name }}" == "discussion" ]; then
            QUESTION="${{ github.event.discussion.title }} ${{ github.event.discussion.body }}"
          else
            QUESTION="${{ github.event.comment.body }}"
          fi

          # Remove @crawlchat mention from question
          QUESTION=$(echo "$QUESTION" | sed 's/@crawlchat//g' | xargs)

          echo "Question: $QUESTION"

          # Call the CrawlChat Answer API
          RESPONSE=$(curl -s -X POST "${{ secrets.API_URL }}/answer/${{ secrets.COLLECTION_ID }}" \
            -H "x-api-key: ${{ secrets.API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"$QUESTION\"}")

          echo "API Response: $RESPONSE"

          # Extract the content from the response
          ANSWER=$(echo "$RESPONSE" | jq -r '.content')

          if [ "$ANSWER" == "null" ] || [ -z "$ANSWER" ]; then
            echo "Failed to get answer from API"
            exit 1
          fi

          echo "answer=$ANSWER" >> $GITHUB_OUTPUT

      - name: Post comment with answer
        if: steps.check_response.outputs.already_responded == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const answer = `${{ steps.api_call.outputs.answer }}`;

            const body = `ðŸ¤– **CrawlChat Answer**

${answer}

---
*This answer was generated by CrawlChat AI based on our documentation.*`;

            if (${{ github.event_name }} === 'issues' || ${{ github.event_name }} === 'issue_comment') {
              // Post comment on issue
              await github.rest.issues.createComment({
                issue_number: ${{ github.event.issue.number }},
                owner: ${{ github.repository_owner }},
                repo: ${{ github.repository }},
                body: body
              });
            } else {
              // Post comment on discussion
              await github.rest.discussions.createComment({
                discussion_number: ${{ github.event.discussion.number }},
                owner: ${{ github.repository_owner }},
                repo: ${{ github.repository }},
                body: body
              });
            }